{% extends 'base.html' %}

{% block title %}Autoservicio - Caja{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Pantalla de Bienvenida -->
    <div id="pantalla-bienvenida" class="row text-center" style="min-height: 80vh; display: flex; align-items: center; justify-content: center;">
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body py-5">
                    <h1 class="display-4 mb-4">
                        <i class="fas fa-shopping-basket"></i>
                    </h1>
                    <h2 class="card-title mb-4">Bienvenido al Autoservicio</h2>
                    <p class="lead mb-4">Coloque su canasta en el √°rea de escaneo y presione el bot√≥n para comenzar</p>
                    <button id="btn-comenzar" class="btn btn-light btn-lg px-5 py-3">
                        <i class="fas fa-play-circle me-2"></i> COMENZAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interfaz Principal de Escaneo (oculta inicialmente) -->
    <div id="interfaz-principal" class="row" style="display: none;">
        <!-- Encabezado -->
        <div class="col-md-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-cash-register me-2"></i>Autoservicio
                </h2>
                <div class="d-flex gap-2">
                    <button id="btn-reiniciar" class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-1"></i> Reiniciar
                    </button>
                    <button id="btn-finalizar" class="btn btn-success" disabled>
                        <i class="fas fa-credit-card me-1"></i> Finalizar Compra
                    </button>
                </div>
            </div>
            <hr>
        </div>

        <!-- Configuraci√≥n RFID -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-rss me-2"></i> Configuraci√≥n Lector RFID
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Puerto COM</label>
                                <select class="form-select" id="puerto-com">
                                    <option value="COM3">COM3</option>
                                    <option value="COM4">COM4</option>
                                    <option value="COM5">COM5</option>
                                    <option value="COM6">COM6</option>
                                    <option value="COM7">COM7</option>
                                    <option value="COM8">COM8</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Acciones RFID</label>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-info btn-sm" id="detectar-puertos">
                                        <i class="fas fa-search"></i> Detectar Puertos
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" id="probar-conexion">
                                        <i class="fas fa-bolt"></i> Probar Conexi√≥n
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm" id="iniciar-lectura-continua">
                                        <i class="fas fa-play"></i> Iniciar Escaneo Continuo
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" id="detener-lectura">
                                        <i class="fas fa-stop"></i> Detener Escaneo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- √Årea de diagn√≥stico -->
                    <div id="area-diagnostico" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <h6>Diagn√≥stico RFID</h6>
                            <div id="diagnostico-info"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- √Årea de Escaneo y Productos -->
        <div class="col-md-8">
            <!-- Estado del Esc√°ner -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-rss me-2"></i>Estado del Esc√°ner RFID
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div id="estado-escanner" class="estado-indicador me-3"></div>
                                <div>
                                    <h6 id="texto-estado">Listo para escanear</h6>
                                    <small class="text-muted" id="detalle-estado">Presione 'Iniciar Escaneo Continuo' para comenzar</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <span class="badge bg-info" id="contador-escaneos">0 escaneos</span>
                                <span class="badge bg-success" id="contador-productos-unicos">0 productos</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Productos Escaneados -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Productos Escaneados
                        <span class="badge bg-light text-primary ms-2" id="contador-productos">0</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="20%">EPC</th>
                                    <th width="30%">Producto</th>
                                    <th width="15%" class="text-center">Precio Unitario</th>
                                    <th width="15%" class="text-center">Cantidad</th>
                                    <th width="15%" class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="lista-productos">
                                <!-- Los productos se insertar√°n aqu√≠ din√°micamente -->
                                <tr id="sin-productos">
                                    <td colspan="6" class="text-center py-5 text-muted">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <p>No se han escaneado productos</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Resumen y Datos del Cliente -->
        <div class="col-md-4">
            <!-- Resumen de Compra -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-receipt me-2"></i>Resumen de Compra
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>Subtotal:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span id="subtotal">Q0.00</span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>IVA (12%):</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span id="iva">Q0.00</span>
                        </div>
                    </div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-6">
                            <h5 class="mb-0"><strong>Total:</strong></h5>
                        </div>
                        <div class="col-6 text-end">
                            <h5 class="mb-0 text-success" id="total">Q0.00</h5>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datos del Cliente -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>Datos del Cliente
                    </h5>
                </div>
                <div class="card-body">
                    <form id="form-cliente">
                        <div class="mb-3">
                            <label for="nit" class="form-label">NIT</label>
                            <input type="text" class="form-control" id="nit" placeholder="Ingrese su NIT" required>
                        </div>
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombre" placeholder="Ingrese su nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="direccion" class="form-label">Direcci√≥n</label>
                            <textarea class="form-control" id="direccion" rows="2" placeholder="Ingrese su direcci√≥n" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email (Opcional)</label>
                            <input type="email" class="form-control" id="email" placeholder="Ingrese su email">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Procesando Pago -->
<div class="modal fade" id="modalProcesando" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Procesando...</span>
                </div>
                <h5>Procesando Pago</h5>
                <p class="text-muted mb-0">Por favor espere...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Compra Exitosa -->
<div class="modal fade" id="modalExito" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Compra Exitosa
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h4>¬°Gracias por su compra!</h4>
                <p class="mb-2"><strong>Total:</strong> <span id="total-final">Q0.00</span></p>
                <p class="text-muted">Su compra ha sido procesada exitosamente</p>
                <div id="detalles-compra" class="text-start mt-3"></div>
                
                <!-- Contador para recargar autom√°ticamente -->
                <div class="mt-4 p-3 bg-light rounded">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    <span id="contador-recarga">La p√°gina se recargar√° autom√°ticamente en <strong>5</strong> segundos...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btn-recargar-ahora">
                    <i class="fas fa-sync-alt me-1"></i> Recargar Ahora
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificaciones adicionales -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastCompraExitosa" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Compra Exitosa</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            Venta #<span id="toast-venta-id"></span> registrada correctamente. Total: <strong id="toast-total"></strong>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.estado-indicador {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: #6c757d;
}

.estado-indicador.activo {
    background-color: #28a745;
    animation: pulse 2s infinite;
}

.estado-indicador.escaneando {
    background-color: #ffc107;
    animation: pulse 0.5s infinite;
}

.estado-indicador.error {
    background-color: #dc3545;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.btn-lg {
    font-size: 1.25rem;
    padding: 1rem 2rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// =============================================
// DATOS DE PRODUCTOS HARDCODEADOS PARA DEMOSTRACI√ìN
// =============================================
const productosDemo = {
    "E280689400005031A1C90D86": {
        id: 1,
        nombre: "Jabon Protex Fresh",
        precio: 5.75,
        descripcion: "jabon de limpieza corporal"
    },
    "AABB0000C209870000000000": {
        id: 2,
        nombre: "1 libra Frijol",
        precio: 8.00,
        descripcion: "frijol entero crudo"
    },
    "AABB0000C209860000000000": {
        id: 3,
        nombre: "1 libra Arroz",
        precio: 6.00,
        descripcion: "1 libra de arroz macarena normal"
    },
    "AABB0000C209840000000000": {
        id: 4,
        nombre: "Atol incaparina grande",
        precio: 12.00,
        descripcion: "bolsa incaparina atol sabor original grande"
    },
    "AABB0000C209830000000000": {
        id: 5,
        nombre: "Galleta Oreo unidad",
        precio: 4.00,
        descripcion: "galleta oreo original unidad"
    }
};

// Variables globales
let productosEscaneados = [];
let lecturaContinuaActiva = false;
let contadorEscaneos = 0;
let intervaloEscaneo;
let totalGlobal = 0;
let contadorRecarga = null;

// Elementos del DOM
const pantallaBienvenida = document.getElementById('pantalla-bienvenida');
const interfazPrincipal = document.getElementById('interfaz-principal');
const btnComenzar = document.getElementById('btn-comenzar');
const btnReiniciar = document.getElementById('btn-reiniciar');
const btnFinalizar = document.getElementById('btn-finalizar');
const listaProductos = document.getElementById('lista-productos');
const sinProductos = document.getElementById('sin-productos');
const contadorProductos = document.getElementById('contador-productos');
const subtotalElement = document.getElementById('subtotal');
const ivaElement = document.getElementById('iva');
const totalElement = document.getElementById('total');
const estadoEscanner = document.getElementById('estado-escanner');
const textoEstado = document.getElementById('texto-estado');
const detalleEstado = document.getElementById('detalle-estado');
const formCliente = document.getElementById('form-cliente');
const contadorEscaneosElement = document.getElementById('contador-escaneos');
const contadorProductosUnicos = document.getElementById('contador-productos-unicos');

// Elementos RFID
const btnDetectarPuertos = document.getElementById('detectar-puertos');
const btnProbarConexion = document.getElementById('probar-conexion');
const btnIniciarLecturaContinua = document.getElementById('iniciar-lectura-continua');
const btnDetenerLectura = document.getElementById('detener-lectura');
const areaDiagnostico = document.getElementById('area-diagnostico');
const diagnosticoInfo = document.getElementById('diagnostico-info');

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    inicializarEventListeners();
    actualizarContadores();
    console.log('Productos demo cargados:', productosDemo);
});

function inicializarEventListeners() {
    btnComenzar.addEventListener('click', comenzarAutoservicio);
    btnReiniciar.addEventListener('click', reiniciarAutoservicio);
    btnFinalizar.addEventListener('click', finalizarCompra);
    
    // Eventos RFID
    btnDetectarPuertos.addEventListener('click', detectarPuertosRFID);
    btnProbarConexion.addEventListener('click', probarConexionRFID);
    btnIniciarLecturaContinua.addEventListener('click', iniciarLecturaContinua);
    btnDetenerLectura.addEventListener('click', detenerLecturaContinua);
    
    // Para recargar manualmente desde modal
    document.getElementById('btn-recargar-ahora').addEventListener('click', function() {
        clearTimeout(contadorRecarga);
        location.reload();
    });
}

function comenzarAutoservicio() {
    pantallaBienvenida.style.display = 'none';
    interfazPrincipal.style.display = 'block';
    
    // Iniciar configuraci√≥n RFID
    inicializarRFID();
}

function reiniciarAutoservicio() {
    productosEscaneados = [];
    contadorEscaneos = 0;
    detenerLecturaContinua();
    actualizarListaProductos();
    formCliente.reset();
    btnFinalizar.disabled = true;
    actualizarContadores();
    
    // Volver a pantalla de bienvenida
    pantallaBienvenida.style.display = 'flex';
    interfazPrincipal.style.display = 'none';
}

function actualizarContadores() {
    contadorEscaneosElement.textContent = `${contadorEscaneos} escaneos`;
    contadorProductosUnicos.textContent = `${productosEscaneados.length} productos`;
}

// =============================================
// FUNCIONALIDAD RFID REAL
// =============================================

function inicializarRFID() {
    estadoEscanner.className = 'estado-indicador';
    textoEstado.textContent = 'RFID Listo';
    detalleEstado.textContent = 'Configure el lector RFID para comenzar';
}

function detectarPuertosRFID() {
    const btn = btnDetectarPuertos;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detectando...';
    btn.disabled = true;

    fetch('{% url "detectar_puertos" %}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '<strong>Puertos detectados:</strong><br>';
            if (data.puertos.length > 0) {
                data.puertos.forEach(puerto => {
                    html += `‚Ä¢ ${puerto.dispositivo} - ${puerto.descripcion}<br>`;
                });
                
                const selectPuerto = document.getElementById('puerto-com');
                selectPuerto.innerHTML = '';
                data.puertos.forEach(puerto => {
                    const option = document.createElement('option');
                    option.value = puerto.dispositivo;
                    option.textContent = `${puerto.dispositivo} - ${puerto.descripcion}`;
                    selectPuerto.appendChild(option);
                });
            } else {
                html += 'No se detectaron puertos seriales';
            }
            
            diagnosticoInfo.innerHTML = html;
            areaDiagnostico.style.display = 'block';
        } else {
            diagnosticoInfo.innerHTML = `<strong>Error:</strong> ${data.error}`;
            areaDiagnostico.style.display = 'block';
        }
    })
    .catch(error => {
        diagnosticoInfo.innerHTML = `<strong>Error de red:</strong> ${error}`;
        areaDiagnostico.style.display = 'block';
    })
    .finally(() => {
        btn.innerHTML = '<i class="fas fa-search"></i> Detectar Puertos';
        btn.disabled = false;
    });
}

function probarConexionRFID() {
    const btn = btnProbarConexion;
    const puerto = document.getElementById('puerto-com').value;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probando...';
    btn.disabled = true;

    estadoEscanner.className = 'estado-indicador escaneando';
    textoEstado.textContent = 'Probando conexi√≥n...';

    const formData = new FormData();
    formData.append('puerto', puerto);

    fetch('{% url "leer_rfid" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            estadoEscanner.className = 'estado-indicador activo';
            textoEstado.textContent = 'Conexi√≥n Exitosa';
            
            let mensaje = `<strong>¬°Conexi√≥n exitosa!</strong><br>`;
            mensaje += `EPC le√≠do: <code>${data.epc}</code><br>`;
            mensaje += `Total de etiquetas detectadas: ${data.total_etiquetas}<br>`;
            
            // Usar datos demo para mostrar informaci√≥n
            const productoDemo = productosDemo[data.epc];
            if (productoDemo) {
                mensaje += `‚úÖ Producto registrado: ${productoDemo.nombre}<br>`;
                mensaje += `üí∞ Precio: Q${productoDemo.precio.toFixed(2)}`;
                
                // Agregar producto autom√°ticamente para prueba
                agregarProductoDesdeEPC(data.epc);
            } else {
                mensaje += '‚ö†Ô∏è Producto no encontrado en base de datos demo';
            }
            
            diagnosticoInfo.innerHTML = mensaje;
            areaDiagnostico.style.display = 'block';
        } else {
            estadoEscanner.className = 'estado-indicador error';
            textoEstado.textContent = 'Error de Conexi√≥n';
            let mensaje = `<strong>Error de conexi√≥n:</strong><br>${data.error}`;
            if (data.sugerencia) {
                mensaje += `<br><em>${data.sugerencia}</em>`;
            }
            diagnosticoInfo.innerHTML = mensaje;
            areaDiagnostico.style.display = 'block';
        }
    })
    .catch(error => {
        estadoEscanner.className = 'estado-indicador error';
        textoEstado.textContent = 'Error de Red';
        diagnosticoInfo.innerHTML = `<strong>Error de red:</strong><br>${error}`;
        areaDiagnostico.style.display = 'block';
    })
    .finally(() => {
        btn.innerHTML = '<i class="fas fa-bolt"></i> Probar Conexi√≥n';
        btn.disabled = false;
    });
}

function iniciarLecturaContinua() {
    const puerto = document.getElementById('puerto-com').value;
    
    if (!puerto) {
        alert('Por favor seleccione un puerto COM primero');
        return;
    }

    lecturaContinuaActiva = true;
    estadoEscanner.className = 'estado-indicador escaneando';
    textoEstado.textContent = 'Escaneo Continuo Activo';
    detalleEstado.textContent = 'Escaneando productos...';

    btnIniciarLecturaContinua.disabled = true;
    btnDetenerLectura.disabled = false;

    // Iniciar escaneo continuo cada 2 segundos
    intervaloEscaneo = setInterval(() => {
        if (lecturaContinuaActiva) {
            ejecutarEscaneoRFID(puerto);
        }
    }, 2000);
}

function detenerLecturaContinua() {
    lecturaContinuaActiva = false;
    clearInterval(intervaloEscaneo);
    
    estadoEscanner.className = 'estado-indicador activo';
    textoEstado.textContent = 'Escaneo Detenido';
    detalleEstado.textContent = 'Presione iniciar para continuar escaneando';

    btnIniciarLecturaContinua.disabled = false;
    btnDetenerLectura.disabled = true;
}

function ejecutarEscaneoRFID(puerto) {
    if (!lecturaContinuaActiva) return;

    const formData = new FormData();
    formData.append('puerto', puerto);

    fetch('{% url "leer_rfid" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return response.json();
    })
    .then(data => {
        contadorEscaneos++;
        actualizarContadores();
        
        if (data.success && data.epc) {
            // Verificar si el EPC est√° en nuestros productos demo
            if (productosDemo[data.epc]) {
                agregarProductoDesdeEPC(data.epc);
                detalleEstado.textContent = `Producto detectado: ${productosDemo[data.epc].nombre}`;
            } else {
                detalleEstado.textContent = `Producto no registrado: ${data.epc}`;
                console.warn('Producto no encontrado en base de datos demo:', data.epc);
            }
        } else {
            detalleEstado.textContent = 'Escaneando... (sin productos detectados)';
        }
    })
    .catch(error => {
        console.error('Error en escaneo:', error);
        detalleEstado.textContent = 'Error en escaneo - Verificar conexi√≥n';
    });
}

// FUNCI√ìN SIMPLIFICADA - Usa datos demo
function agregarProductoDesdeEPC(epc) {
    console.log('Procesando EPC:', epc);
    
    // Buscar producto en datos demo
    const productoDemo = productosDemo[epc];
    
    if (!productoDemo) {
        console.error('Producto no encontrado para EPC:', epc);
        return;
    }
    
    console.log('Producto encontrado:', productoDemo);
    
    // Buscar si el producto ya est√° en la lista
    const productoExistente = productosEscaneados.find(p => p.epc === epc);
    
    if (productoExistente) {
        // Incrementar cantidad si ya existe
        productoExistente.cantidad += 1;
        console.log(`Producto existente: ${productoExistente.nombre}, nueva cantidad: ${productoExistente.cantidad}`);
    } else {
        // Agregar nuevo producto
        const nuevoProducto = {
            id: productoDemo.id,
            epc: epc,
            nombre: productoDemo.nombre,
            precio: productoDemo.precio,
            cantidad: 1
        };
        productosEscaneados.push(nuevoProducto);
        console.log('Nuevo producto agregado:', nuevoProducto);
    }
    
    actualizarListaProductos();
}

// =============================================
// GESTI√ìN DE PRODUCTOS Y COMPRA
// =============================================

function actualizarListaProductos() {
    // Limpiar lista
    listaProductos.innerHTML = '';
    
    if (productosEscaneados.length === 0) {
        listaProductos.appendChild(sinProductos);
        contadorProductos.textContent = '0';
        btnFinalizar.disabled = true;
    } else {
        // Generar filas de productos
        productosEscaneados.forEach((producto, index) => {
            const precio = Number(producto.precio) || 0;
            const cantidad = Number(producto.cantidad) || 0;
            const subtotal = precio * cantidad;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><code>${producto.epc.substring(0, 10)}...</code></td>
                <td>${producto.nombre}</td>
                <td class="text-center">Q${precio.toFixed(2)}</td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="cambiarCantidad(${index}, -1)">-</button>
                        <span class="btn btn-light" style="min-width: 40px;">${cantidad}</span>
                        <button class="btn btn-outline-secondary" onclick="cambiarCantidad(${index}, 1)">+</button>
                    </div>
                </td>
                <td class="text-end">Q${subtotal.toFixed(2)}</td>
            `;
            listaProductos.appendChild(tr);
        });
        
        contadorProductos.textContent = productosEscaneados.length;
        btnFinalizar.disabled = false;
    }
    
    actualizarResumen();
    actualizarContadores();
}

function cambiarCantidad(index, cambio) {
    const producto = productosEscaneados[index];
    const cantidadActual = Number(producto.cantidad) || 0;
    const nuevaCantidad = cantidadActual + cambio;
    
    if (nuevaCantidad <= 0) {
        // Eliminar producto si la cantidad llega a 0
        productosEscaneados.splice(index, 1);
    } else {
        producto.cantidad = nuevaCantidad;
    }
    
    actualizarListaProductos();
}

function actualizarResumen() {
    const subtotal = productosEscaneados.reduce((sum, producto) => {
        const precio = Number(producto.precio) || 0;
        const cantidad = Number(producto.cantidad) || 0;
        return sum + (precio * cantidad);
    }, 0);
    
    const iva = subtotal * 0.12; // 12% IVA
    totalGlobal = subtotal + iva; // Guardar el total globalmente
    
    subtotalElement.textContent = `Q${subtotal.toFixed(2)}`;
    ivaElement.textContent = `Q${iva.toFixed(2)}`;
    totalElement.textContent = `Q${totalGlobal.toFixed(2)}`;
}

// =============================================
// FUNCI√ìN MEJORADA PARA FINALIZAR COMPRA
// =============================================

function finalizarCompra() {
    // Validar datos del cliente
    const nit = document.getElementById('nit').value.trim();
    const nombre = document.getElementById('nombre').value.trim();
    const direccion = document.getElementById('direccion').value.trim();
    
    if (!nit || !nombre || !direccion) {
        alert('Por favor complete todos los datos del cliente (NIT, Nombre y Direcci√≥n)');
        return;
    }
    
    if (productosEscaneados.length === 0) {
        alert('No hay productos escaneados');
        return;
    }
    
    // Detener escaneo continuo
    detenerLecturaContinua();
    
    // Deshabilitar bot√≥n para evitar m√∫ltiples clics
    btnFinalizar.disabled = true;
    
    // Mostrar modal de procesamiento
    $('#modalProcesando').modal('show');
    
    // Preparar datos para enviar al servidor
    const datosVenta = {
        productos: productosEscaneados,
        cliente: {
            nit: nit,
            nombre: nombre,
            direccion: direccion,
            email: document.getElementById('email').value.trim()
        },
        subtotal: parseFloat(subtotalElement.textContent.replace('Q', '')),
        iva: parseFloat(ivaElement.textContent.replace('Q', '')),
        total: totalGlobal
    };
    
    console.log('Enviando datos de venta:', datosVenta);
    
    // Enviar datos al servidor (AJAX real)
    fetch('{% url "registrar_venta" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(datosVenta)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return response.json();
    })
    .then(data => {
        $('#modalProcesando').modal('hide');
        
        if (data.success) {
            // Mostrar detalles de la compra en el modal
            mostrarDetallesCompra(data.venta_id);
            
            document.getElementById('total-final').textContent = `Q${totalGlobal.toFixed(2)}`;
            $('#modalExito').modal('show');
            
            // Mostrar toast de confirmaci√≥n adicional
            mostrarToastExito(data.venta_id, totalGlobal);
            
            console.log('Venta registrada exitosamente:', data);
            
            // Iniciar contador para recarga autom√°tica
            iniciarContadorRecarga();
            
        } else {
            alert('Error al registrar la venta: ' + data.error);
            // Reactivar el bot√≥n de finalizar compra
            btnFinalizar.disabled = false;
        }
    })
    .catch(error => {
        $('#modalProcesando').modal('hide');
        console.error('Error al registrar venta:', error);
        alert('Error de conexi√≥n al registrar la venta: ' + error.message);
        // Reactivar el bot√≥n de finalizar compra
        btnFinalizar.disabled = false;
    });
}

function mostrarDetallesCompra(ventaId) {
    const detallesDiv = document.getElementById('detalles-compra');
    let html = '<h6>Detalles de la compra:</h6>';
    html += '<div class="small">';
    
    productosEscaneados.forEach(producto => {
        const subtotal = producto.precio * producto.cantidad;
        html += `<div class="d-flex justify-content-between">
            <span>${producto.nombre} x${producto.cantidad}</span>
            <span>Q${subtotal.toFixed(2)}</span>
        </div>`;
    });
    
    html += `<hr>
        <div class="d-flex justify-content-between">
            <strong>N√∫mero de venta:</strong>
            <strong>#${ventaId}</strong>
        </div>
        <div class="d-flex justify-content-between">
            <strong>Cliente:</strong>
            <strong>${document.getElementById('nombre').value}</strong>
        </div>
        <div class="d-flex justify-content-between">
            <strong>NIT:</strong>
            <strong>${document.getElementById('nit').value}</strong>
        </div>`;
    html += '</div>';
    
    detallesDiv.innerHTML = html;
}

// =============================================
// FUNCIONALIDAD DE RECARGA AUTOM√ÅTICA
// =============================================

function iniciarContadorRecarga() {
    let segundos = 5;
    const contadorElement = document.getElementById('contador-recarga');
    
    // Actualizar contador cada segundo
    contadorRecarga = setInterval(() => {
        contadorElement.innerHTML = `La p√°gina se recargar√° autom√°ticamente en <strong>${segundos}</strong> segundos...`;
        segundos--;
        
        if (segundos < 0) {
            clearInterval(contadorRecarga);
            location.reload();
        }
    }, 1000);
}

// =============================================
// TOAST DE CONFIRMACI√ìN ADICIONAL
// =============================================

function mostrarToastExito(ventaId, total) {
    document.getElementById('toast-venta-id').textContent = ventaId;
    document.getElementById('toast-total').textContent = `Q${total.toFixed(2)}`;
    
    const toast = new bootstrap.Toast(document.getElementById('toastCompraExitosa'));
    toast.show();
}

// =============================================
// FUNCIONALIDADES ADICIONALES
// =============================================

// Para desarrollo: atajar la tecla F2 para iniciar/detener escaneo
document.addEventListener('keydown', function(e) {
    if (e.key === 'F2') {
        e.preventDefault();
        if (lecturaContinuaActiva) {
            detenerLecturaContinua();
        } else {
            iniciarLecturaContinua();
        }
    }
});

// Funci√≥n para agregar productos demo manualmente (para testing sin RFID)
function agregarProductoDemo(epc) {
    if (productosDemo[epc]) {
        agregarProductoDesdeEPC(epc);
    } else {
        console.error('EPC no encontrado en productos demo:', epc);
    }
}

// Exponer funciones globalmente para testing
window.agregarProductoDemo = agregarProductoDemo;
window.productosDemo = productosDemo;
window.finalizarCompra = finalizarCompra;
</script>
{% endblock %}