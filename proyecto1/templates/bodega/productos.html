{% extends 'base.html' %}

{% block title %}Gestión de Productos - Bodega{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">
                <i class="fas fa-boxes"></i> Gestión de Productos
            </h2>
        </div>
    </div>

    <!-- Mensajes de éxito/error -->
    {% if messages %}
    <div class="row mb-4">
        <div class="col-md-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Monitor Serial en Tiempo Real -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-terminal"></i> Monitor Serial - Comunicación RFID
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
                        <div>
                            <span class="badge bg-primary" id="estado-conexion">Desconectado</span>
                            <span class="badge bg-secondary ms-2" id="contador-datos">0 bytes</span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success" id="iniciar-monitor">
                                <i class="fas fa-play"></i> Iniciar Monitor
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="detener-monitor">
                                <i class="fas fa-stop"></i> Detener
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning" id="limpiar-monitor">
                                <i class="fas fa-broom"></i> Limpiar
                            </button>
                        </div>
                    </div>
                    <div id="monitor-serial" 
                         style="height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; padding: 15px; font-size: 14px; white-space: pre-wrap;">
>> Sistema listo. Haga clic en "Iniciar Monitor" para comenzar.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuración Lector RFID -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog"></i> Configuración Lector RFID
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Puerto COM</label>
                                <select class="form-select" id="puerto-com">
                                    <option value="COM3">COM3</option>
                                    <option value="COM4">COM4</option>
                                    <option value="COM5">COM5</option>
                                    <option value="COM6">COM6</option>
                                    <option value="COM7">COM7</option>
                                    <option value="COM8">COM8</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Acciones</label>
                                <div>
                                    <button type="button" class="btn btn-info btn-sm" id="detectar-puertos">
                                        <i class="fas fa-search"></i> Detectar Puertos
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" id="probar-conexion">
                                        <i class="fas fa-bolt"></i> Probar Conexión
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Área de diagnóstico -->
                    <div id="area-diagnostico" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <h6>Diagnóstico RFID</h6>
                            <div id="diagnostico-info"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario para agregar producto -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plus-circle"></i> Agregar Nuevo Producto
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Mostrar errores del formulario -->
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>Por favor corrige los siguientes errores:</strong>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <form method="post" id="producto-form">
                        {% csrf_token %}
                        
                        <!-- Campo EPC con lectura RFID -->
                        <div class="mb-3">
                            <label for="id_epc" class="form-label">EPC RFID <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" name="epc" id="id_epc" class="form-control {% if form.epc.errors %}is-invalid{% endif %}" 
                                       value="{{ form.epc.value|default:'' }}" 
                                       placeholder="Ej: AABB0000C209870000000000" required
                                       maxlength="24">
                                <button type="button" class="btn btn-outline-primary" id="leer-rfid-simple">
                                    <i class="fas fa-rss"></i> Leer RFID
                                </button>
                                <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalMultiRFID">
                                    <i class="fas fa-layer-group"></i> Múltiple
                                </button>
                            </div>
                            <div class="form-text">Haz clic en "Leer RFID" para capturar el código de la etiqueta (24 caracteres hexadecimales)</div>
                            {% if form.epc.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.epc.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_nombre" class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
                                    <input type="text" name="nombre" id="id_nombre" class="form-control {% if form.nombre.errors %}is-invalid{% endif %}" 
                                           value="{{ form.nombre.value|default:'' }}" 
                                           placeholder="Ej: Smartphone X1" required>
                                    {% if form.nombre.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.nombre.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_marca" class="form-label">Marca</label>
                                    <select name="marca" id="id_marca" class="form-control {% if form.marca.errors %}is-invalid{% endif %}">
                                        <option value="">Selecciona una marca</option>
                                        {% for marca in marcas %}
                                        <option value="{{ marca.id }}" 
                                                {% if form.marca.value|stringformat:"s" == marca.id|stringformat:"s" %}selected{% endif %}>
                                            {{ marca.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if form.marca.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.marca.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="id_descripcion" class="form-label">Descripción</label>
                            <textarea name="descripcion" id="id_descripcion" class="form-control {% if form.descripcion.errors %}is-invalid{% endif %}" 
                                      rows="3" placeholder="Descripción del producto...">{{ form.descripcion.value|default:'' }}</textarea>
                            {% if form.descripcion.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.descripcion.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_precio_compra" class="form-label">Precio Compra (Q)</label>
                                    <input type="number" name="precio_compra" id="id_precio_compra" 
                                           class="form-control {% if form.precio_compra.errors %}is-invalid{% endif %}" 
                                           value="{{ form.precio_compra.value|default:'0.00' }}" 
                                           step="0.01" min="0" placeholder="0.00">
                                    {% if form.precio_compra.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.precio_compra.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_precio_venta" class="form-label">Precio Venta (Q) <span class="text-danger">*</span></label>
                                    <input type="number" name="precio_venta" id="id_precio_venta" 
                                           class="form-control {% if form.precio_venta.errors %}is-invalid{% endif %}" 
                                           value="{{ form.precio_venta.value|default:'0.00' }}" 
                                           step="0.01" min="0" placeholder="0.00" required>
                                    {% if form.precio_venta.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.precio_venta.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_stock" class="form-label">Stock <span class="text-danger">*</span></label>
                                    <input type="number" name="stock" id="id_stock" 
                                           class="form-control {% if form.stock.errors %}is-invalid{% endif %}" 
                                           value="{{ form.stock.value|default:'0' }}" 
                                           min="0" required>
                                    {% if form.stock.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.stock.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_distribuidor" class="form-label">Distribuidor</label>
                                    <select name="distribuidor" id="id_distribuidor" class="form-control {% if form.distribuidor.errors %}is-invalid{% endif %}">
                                        <option value="">Selecciona un distribuidor</option>
                                        {% for distribuidor in distribuidores %}
                                        <option value="{{ distribuidor.id }}" 
                                                {% if form.distribuidor.value|stringformat:"s" == distribuidor.id|stringformat:"s" %}selected{% endif %}>
                                            {{ distribuidor.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if form.distribuidor.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.distribuidor.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_fecha_vencimiento" class="form-label">Fecha Vencimiento</label>
                                    <input type="date" name="fecha_vencimiento" id="id_fecha_vencimiento" 
                                           class="form-control {% if form.fecha_vencimiento.errors %}is-invalid{% endif %}" 
                                           value="{{ form.fecha_vencimiento.value|default:'' }}">
                                    {% if form.fecha_vencimiento.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.fecha_vencimiento.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_codigo_barras" class="form-label">Código de Barras</label>
                                    <input type="text" name="codigo_barras" id="id_codigo_barras" 
                                           class="form-control {% if form.codigo_barras.errors %}is-invalid{% endif %}" 
                                           value="{{ form.codigo_barras.value|default:'' }}" 
                                           placeholder="Opcional">
                                    {% if form.codigo_barras.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.codigo_barras.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_peso" class="form-label">Peso (kg)</label>
                                    <input type="number" name="peso" id="id_peso" 
                                           class="form-control {% if form.peso.errors %}is-invalid{% endif %}" 
                                           value="{{ form.peso.value|default:'0' }}" 
                                           step="0.01" min="0" placeholder="0.00">
                                    {% if form.peso.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.peso.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_stock_minimo" class="form-label">Stock Mínimo</label>
                                    <input type="number" name="stock_minimo" id="id_stock_minimo" 
                                           class="form-control {% if form.stock_minimo.errors %}is-invalid{% endif %}" 
                                           value="{{ form.stock_minimo.value|default:'0' }}" 
                                           min="0" placeholder="0">
                                    {% if form.stock_minimo.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.stock_minimo.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_ubicacion" class="form-label">Ubicación</label>
                                    <input type="text" name="ubicacion" id="id_ubicacion" 
                                           class="form-control {% if form.ubicacion.errors %}is-invalid{% endif %}" 
                                           value="{{ form.ubicacion.value|default:'' }}" 
                                           placeholder="Ej: Almacén A, Estante B">
                                    {% if form.ubicacion.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.ubicacion.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Guardar Producto
                            </button>
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-undo"></i> Limpiar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Lista de productos -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> Lista de Productos ({{ productos.count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if productos %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>EPC</th>
                                    <th>Nombre</th>
                                    <th>Precio Venta</th>
                                    <th>Stock</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos %}
                                <tr>
                                    <td><code>{{ producto.epc|truncatechars:12 }}</code></td>
                                    <td>
                                        <strong>{{ producto.nombre }}</strong>
                                        {% if producto.marca %}
                                        <br><small class="text-muted">{{ producto.marca.nombre }}</small>
                                        {% endif %}
                                    </td>
                                    <td>Q{{ producto.precio_venta|default:"0.00" }}</td>
                                    <td>
                                        <span class="badge {% if producto.stock > 10 %}bg-success{% elif producto.stock > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ producto.stock }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'editar_producto' producto.id %}" class="btn btn-sm btn-outline-primary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger btn-eliminar" 
                                                title="Eliminar" 
                                                data-producto-id="{{ producto.id }}" 
                                                data-producto-nombre="{{ producto.nombre }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay productos registrados</h5>
                        <p class="text-muted">Comienza agregando tu primer producto usando el formulario.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para lectura múltiple RFID -->
<div class="modal fade" id="modalMultiRFID" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lectura Múltiple RFID</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Cantidad de productos a escanear:</label>
                    <input type="number" class="form-control" id="cantidad-productos" value="1" min="1" max="50">
                </div>
                <button type="button" class="btn btn-primary w-100" id="iniciar-lectura-multiple">
                    <i class="fas fa-play"></i> Iniciar Lectura Múltiple
                </button>
                <div id="resultado-multiple" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6>¿Estás seguro de que deseas eliminar este producto?</h6>
                    <p class="mb-0"><strong>Producto:</strong> <span id="nombre-producto-eliminar"></span></p>
                    <p class="mb-0"><strong>EPC:</strong> <span id="epc-producto-eliminar"></span></p>
                </div>
                <p class="text-danger">
                    <strong>Esta acción es irreversible.</strong> Todos los datos del producto 
                    serán eliminados permanentemente del sistema.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <form method="post" action="" id="form-eliminar-producto" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Sí, Eliminar Permanentemente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =============================================
// MONITOR SERIAL
// =============================================
let monitorActivo = false;
let contadorBytes = 0;

function agregarAlMonitor(mensaje, tipo = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    let prefijo = '>>';
    let color = '#00ff00';
    
    switch(tipo) {
        case 'comando': prefijo = '>>> ENVIADO'; color = '#ffff00'; break;
        case 'respuesta': prefijo = '<<< RECIBIDO'; color = '#00ffff'; break;
        case 'error': prefijo = '!!! ERROR'; color = '#ff0000'; break;
        case 'exito': prefijo = '*** ÉXITO'; color = '#00ff00'; break;
        case 'debug': prefijo = '--- DEBUG'; color = '#888888'; break;
    }
    
    const linea = `<div style="color: ${color}">[${timestamp}] ${prefijo}: ${mensaje}</div>`;
    const monitor = document.getElementById('monitor-serial');
    monitor.innerHTML += linea;
    monitor.scrollTop = monitor.scrollHeight;
    
    if (tipo === 'respuesta') {
        contadorBytes += mensaje.length;
        document.getElementById('contador-datos').textContent = contadorBytes + ' bytes';
    }
}

function limpiarMonitor() {
    document.getElementById('monitor-serial').innerHTML = '>> Monitor limpiado. Listo para nueva sesión.\n';
    contadorBytes = 0;
    document.getElementById('contador-datos').textContent = '0 bytes';
}

// =============================================
// ELIMINACIÓN DE PRODUCTOS
// =============================================

// Configurar eventos para botones de eliminar
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para botones de eliminar
    document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', function() {
            const productoId = this.getAttribute('data-producto-id');
            const productoNombre = this.getAttribute('data-producto-nombre');
            const productoEpc = this.closest('tr').querySelector('td:first-child code').textContent;
            
            mostrarModalEliminacion(productoId, productoNombre, productoEpc);
        });
    });

    // Configurar el formulario de eliminación
    const formEliminar = document.getElementById('form-eliminar-producto');
    if (formEliminar) {
        formEliminar.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEliminar'));
                    modal.hide();
                    
                    // Mostrar mensaje de éxito
                    mostrarMensaje('success', `Producto "${data.nombre_producto}" eliminado exitosamente`);
                    
                    // Recargar la página después de un breve delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    mostrarMensaje('error', 'Error al eliminar el producto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('error', 'Error de conexión al eliminar el producto');
            });
        });
    }
});

function mostrarModalEliminacion(productoId, productoNombre, productoEpc) {
    document.getElementById('nombre-producto-eliminar').textContent = productoNombre;
    document.getElementById('epc-producto-eliminar').textContent = productoEpc;
    
    // Actualizar la acción del formulario
    const formEliminar = document.getElementById('form-eliminar-producto');
    formEliminar.action = "{% url 'eliminar_producto' 0 %}".replace('0', productoId);
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalEliminar'));
    modal.show();
}

function mostrarMensaje(tipo, mensaje) {
    // Crear elemento de alerta
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insertar después del primer row
    const mensajesContainer = document.querySelector('.container-fluid .row:first-child');
    if (mensajesContainer) {
        mensajesContainer.parentNode.insertBefore(alertDiv, mensajesContainer.nextSibling);
    }
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Event Listeners para el monitor
document.getElementById('iniciar-monitor').addEventListener('click', function() {
    monitorActivo = true;
    document.getElementById('estado-conexion').textContent = 'Monitor Activo';
    document.getElementById('estado-conexion').className = 'badge bg-success';
    agregarAlMonitor('Monitor serial activado. Listo para comunicación.', 'exito');
});

document.getElementById('detener-monitor').addEventListener('click', function() {
    monitorActivo = false;
    document.getElementById('estado-conexion').textContent = 'Monitor Inactivo';
    document.getElementById('estado-conexion').className = 'badge bg-danger';
    agregarAlMonitor('Monitor serial detenido.', 'info');
});

document.getElementById('limpiar-monitor').addEventListener('click', limpiarMonitor);

// =============================================
// FUNCIONALIDAD RFID
// =============================================

// Detectar puertos disponibles
document.getElementById('detectar-puertos').addEventListener('click', function() {
    const btn = this;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detectando...';
    btn.disabled = true;

    agregarAlMonitor('Iniciando detección de puertos seriales...', 'info');

    fetch('{% url "detectar_puertos" %}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agregarAlMonitor(`Detección completada. ${data.puertos.length} puertos encontrados.`, 'exito');
            
            let html = '<strong>Puertos detectados:</strong><br>';
            if (data.puertos.length > 0) {
                data.puertos.forEach(puerto => {
                    html += `• ${puerto.dispositivo} - ${puerto.descripcion}<br>`;
                    agregarAlMonitor(`Puerto detectado: ${puerto.dispositivo} - ${puerto.descripcion}`, 'debug');
                });
                
                const selectPuerto = document.getElementById('puerto-com');
                selectPuerto.innerHTML = '';
                data.puertos.forEach(puerto => {
                    const option = document.createElement('option');
                    option.value = puerto.dispositivo;
                    option.textContent = `${puerto.dispositivo} - ${puerto.descripcion}`;
                    selectPuerto.appendChild(option);
                });
            } else {
                html += 'No se detectaron puertos seriales';
                agregarAlMonitor('No se encontraron puertos seriales disponibles.', 'error');
            }
            
            document.getElementById('diagnostico-info').innerHTML = html;
            document.getElementById('area-diagnostico').style.display = 'block';
        } else {
            agregarAlMonitor(`Error en detección: ${data.error}`, 'error');
            document.getElementById('diagnostico-info').innerHTML = `<strong>Error:</strong> ${data.error}`;
            document.getElementById('area-diagnostico').style.display = 'block';
        }
    })
    .catch(error => {
        agregarAlMonitor(`Error de red: ${error}`, 'error');
        document.getElementById('diagnostico-info').innerHTML = `<strong>Error de red:</strong> ${error}`;
        document.getElementById('area-diagnostico').style.display = 'block';
    })
    .finally(() => {
        btn.innerHTML = '<i class="fas fa-search"></i> Detectar Puertos';
        btn.disabled = false;
    });
});

// Probar conexión RFID
document.getElementById('probar-conexion').addEventListener('click', function() {
    const btn = this;
    const puerto = document.getElementById('puerto-com').value;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probando...';
    btn.disabled = true;

    agregarAlMonitor(`Iniciando prueba de conexión en ${puerto}...`, 'info');

    const formData = new FormData();
    formData.append('puerto', puerto);

    fetch('{% url "leer_rfid" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agregarAlMonitor(`Comando enviado: "R"`, 'comando');
            agregarAlMonitor(`Respuesta recibida: ${data.respuesta_cruda}`, 'respuesta');
            agregarAlMonitor(`Conexión exitosa! EPC: ${data.epc}`, 'exito');
            
            let mensaje = `<strong>¡Conexión exitosa!</strong><br>`;
            mensaje += `EPC leído: <code>${data.epc}</code><br>`;
            mensaje += `Total de etiquetas detectadas: ${data.total_etiquetas}<br>`;
            if (data.existe) {
                mensaje += `✅ Producto registrado: ${data.producto.nombre}`;
            } else {
                mensaje += '⚠️ Producto no registrado en base de datos';
            }
            document.getElementById('diagnostico-info').innerHTML = mensaje;
            document.getElementById('area-diagnostico').style.display = 'block';
        } else {
            agregarAlMonitor(`Error de conexión: ${data.error}`, 'error');
            let mensaje = `<strong>Error de conexión:</strong><br>${data.error}`;
            if (data.sugerencia) {
                mensaje += `<br><em>${data.sugerencia}</em>`;
            }
            if (data.respuesta_cruda) {
                mensaje += `<br><small>Respuesta del lector: ${data.respuesta_cruda}</small>`;
                agregarAlMonitor(`Respuesta cruda: ${data.respuesta_cruda}`, 'debug');
            }
            document.getElementById('diagnostico-info').innerHTML = mensaje;
            document.getElementById('area-diagnostico').style.display = 'block';
        }
    })
    .catch(error => {
        agregarAlMonitor(`Error de red: ${error}`, 'error');
        document.getElementById('diagnostico-info').innerHTML = `<strong>Error de red:</strong><br>${error}`;
        document.getElementById('area-diagnostico').style.display = 'block';
    })
    .finally(() => {
        btn.innerHTML = '<i class="fas fa-bolt"></i> Probar Conexión';
        btn.disabled = false;
    });
});

// Lectura RFID simple
document.getElementById('leer-rfid-simple').addEventListener('click', function() {
    const btn = this;
    const puerto = document.getElementById('puerto-com').value;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Leyendo...';
    btn.disabled = true;

    agregarAlMonitor(`Iniciando lectura RFID en ${puerto}...`, 'info');

    const formData = new FormData();
    formData.append('puerto', puerto);

    fetch('{% url "leer_rfid" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agregarAlMonitor(`Comando enviado: "R"`, 'comando');
            agregarAlMonitor(`Respuesta completa: ${data.respuesta_cruda}`, 'respuesta');
            agregarAlMonitor(`EPC extraído: ${data.epc}`, 'exito');
            
            document.getElementById('id_epc').value = data.epc;
            let mensaje = `✅ EPC leído: ${data.epc}`;
            if (data.total_etiquetas > 1) {
                mensaje += `\n⚠️ Se detectaron ${data.total_etiquetas} etiquetas, usando la primera`;
            }
            if (data.existe) {
                mensaje += `\n✅ Producto existente: ${data.producto.nombre}`;
            } else {
                mensaje += `\n⚠️ Producto no registrado - Complete los datos`;
            }
            alert(mensaje);
        } else {
            agregarAlMonitor(`Error en lectura: ${data.error}`, 'error');
            let mensajeError = `❌ Error: ${data.error}`;
            if (data.respuesta_cruda) {
                mensajeError += `\nRespuesta del lector: ${data.respuesta_cruda}`;
                agregarAlMonitor(`Respuesta cruda: ${data.respuesta_cruda}`, 'debug');
            }
            alert(mensajeError);
        }
    })
    .catch(error => {
        agregarAlMonitor(`Error de conexión: ${error}`, 'error');
        alert('Error de conexión: ' + error);
    })
    .finally(() => {
        btn.innerHTML = '<i class="fas fa-rss"></i> Leer RFID';
        btn.disabled = false;
    });
});

// Lectura múltiple RFID
document.getElementById('iniciar-lectura-multiple').addEventListener('click', function() {
    const btn = this;
    const cantidad = document.getElementById('cantidad-productos').value;
    const puerto = document.getElementById('puerto-com').value;
    const resultadoDiv = document.getElementById('resultado-multiple');
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Escaneando...';
    btn.disabled = true;
    resultadoDiv.innerHTML = '';

    agregarAlMonitor(`Iniciando lectura múltiple. Cantidad: ${cantidad}, Puerto: ${puerto}`, 'info');

    const formData = new FormData();
    formData.append('cantidad', cantidad);
    formData.append('puerto', puerto);

    fetch('{% url "leer_multiple_rfid" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agregarAlMonitor(`Comando enviado: "R"`, 'comando');
            agregarAlMonitor(`Respuesta completa: ${data.respuesta_cruda}`, 'respuesta');
            agregarAlMonitor(`Lectura múltiple exitosa. ${data.total} etiquetas procesadas.`, 'exito');
            
            let html = `<div class="alert alert-success">
                <strong>¡Éxito!</strong> Se leyeron ${data.total} etiquetas (de ${data.total_detectadas} detectadas):
            </div>`;
            html += '<div class="list-group">';
            data.epcs.forEach((epc, index) => {
                html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${index + 1}.</strong> <code>${epc}</code>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="usarEPC('${epc}')">
                        Usar
                    </button>
                </div>`;
            });
            html += '</div>';
            
            if (data.total_detectadas > data.total) {
                html += `<div class="alert alert-warning mt-2">
                    <small>Se detectaron ${data.total_detectadas} etiquetas pero se mostraron ${data.total} según la cantidad solicitada.</small>
                </div>`;
            }
            
            resultadoDiv.innerHTML = html;
        } else {
            agregarAlMonitor(`Error en lectura múltiple: ${data.error}`, 'error');
            resultadoDiv.innerHTML = `<div class="alert alert-danger">
                <strong>Error:</strong> ${data.error}
                ${data.respuesta_cruda ? `<br><small>Respuesta: ${data.respuesta_cruda}</small>` : ''}
            </div>`;
        }
    })
    .catch(error => {
        agregarAlMonitor(`Error de conexión en lectura múltiple: ${error}`, 'error');
        resultadoDiv.innerHTML = `<div class="alert alert-danger">Error de conexión: ${error}</div>`;
    })
    .finally(() => {
        btn.innerHTML = '<i class="fas fa-play"></i> Iniciar Lectura Múltiple';
        btn.disabled = false;
    });
});

function usarEPC(epc) {
    document.getElementById('id_epc').value = epc;
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalMultiRFID'));
    modal.hide();
    
    agregarAlMonitor(`EPC ${epc} asignado al formulario.`, 'exito');
    alert(`EPC ${epc} asignado al formulario`);
}

// =============================================
// INICIALIZACIÓN
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    agregarAlMonitor('Sistema RFID inicializado. Haga clic en "Iniciar Monitor" para comenzar.', 'info');
    
    // Auto-seleccionar el primer puerto COM disponible
    setTimeout(() => {
        const selectPuerto = document.getElementById('puerto-com');
        if (selectPuerto.options.length > 0) {
            selectPuerto.selectedIndex = 0;
        }
    }, 1000);
});
</script>
{% endblock %}